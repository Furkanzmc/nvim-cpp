---

name: Formatting

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  clang_format_diff:
    name: clang_format
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout/issues/416
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup PR Branch
        run: git branch ${{ github.base_ref }} origin/${{ github.base_ref }}

      - name: Install clang-format
        run: sudo apt update && sudo apt install clang-format-13 && echo "clang-format version is $(clang-format --version)"

      - name: Run clang-format
        run: >
          git diff ${{ github.base_ref }} --name-only | grep -v templates | grep -e "\.cpp$" -e "\.h$" | xargs clang-format -i --style file && git diff > clang_format.patch && git reset --hard

      - name: Detect clang_format Changes
        run: |
          if [ -s clang_format.patch ]; then
            echo "changes_detected=true" >> $GITHUB_ENV
          else
            echo "changes_detected=false" >> $GITHUB_ENV
          fi

      - name: Upload Artifacts
        if: fromJSON(env.changes_detected)
        uses: actions/upload-artifact@v2
        with:
          name: clang_format Patch
          path: clang_format.patch

      - name: Patch File
        run: |
          if [ -s clang_format.patch ]; then
            cat clang_format.patch
          fi

      - name: Check Validity
        run: |
          if [ -s clang_format.patch ]; then
            echo "+-----------------------------------------------------------+"
            echo "|                          CLANG FORMAT FAILURE             |"
            echo "+-----------------------------------------------------------+"
            echo "|                                                           |"
            echo "| Your changes are not clang-format compliant!              |"
            echo "|                                                           |"
            echo "| An Artifact 'clang_format Patch' was uploaded.            |"
            echo "|                                                           |"
            echo "| Consider inspecting and applying 'clang_format.patch':    |"
            echo "|   git apply clang_format.patch                            |"
            echo "|                                                           |"
            echo "| The contents of 'clang_format.patch' is printed below.    |"
            echo "|                                                           |"
            echo "+-----------------------------------------------------------+"
            cat clang_format.patch
            echo "------------------------------------------------------------"
            exit 1
          fi
